<!DOCTYPE html>
<html>
<head>
    <title>Transcritor Avan√ßado</title>
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .upload-area { 
            border: 2px dashed #ccc; 
            padding: 40px; 
            text-align: center; 
            margin: 20px 0;
            border-radius: 10px;
        }
        .resultado { 
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0;
            white-space: pre-wrap;
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Transcritor de √Åudio Online</h1>
        
        <div class="upload-area">
            <input type="file" id="audioFile" accept="audio/*" style="display: none;">
            <button onclick="document.getElementById('audioFile').click()">
                Selecionar Arquivo de √Åudio
            </button>
            <p>ou arraste e solte aqui</p>
            <div id="arquivoSelecionado"></div>
        </div>

        <button onclick="transcreverAudio()" id="btnTranscrever">Transcrever √Åudio</button>
        
        <div id="loading" style="display: none;">
            <p>‚è≥ Processando... Isso pode levar alguns minutos.</p>
        </div>

        <div id="resultado" class="resultado"></div>

        <div id="botoesExportacao" style="display: none;">
            <button onclick="exportarCSV()">üì• Download CSV</button>
            <button onclick="salvarNoSheets()">üìä Salvar no Google Sheets</button>
            <button onclick="copiarTexto()">üìã Copiar Texto</button>
        </div>
    </div>

    <script>
        let transcricaoAtual = '';
        let modeloCarregado = null;

        // Configurar √°rea de drag & drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#007cba';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                document.getElementById('audioFile').files = e.dataTransfer.files;
                atualizarInterfaceArquivo(file.name);
            }
        });

        document.getElementById('audioFile').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                atualizarInterfaceArquivo(e.target.files[0].name);
            }
        });

        function atualizarInterfaceArquivo(nome) {
            document.getElementById('arquivoSelecionado').innerHTML = 
                `<strong>Arquivo selecionado:</strong> ${nome}`;
        }

        async function carregarModelo() {
            if (!modeloCarregado) {
                modeloCarregado = await pipeline(
                    'automatic-speech-recognition', 
                    'Xenova/whisper-tiny'
                );
            }
            return modeloCarregado;
        }

        async function transcreverAudio() {
            const file = document.getElementById('audioFile').files[0];
            if (!file) {
                alert('Por favor, selecione um arquivo de √°udio.');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('btnTranscrever').disabled = true;

            try {
                const transcriber = await carregarModelo();
                const output = await transcriber(file, {
                    chunk_length_s: 30,
                    stride_length_s: 5,
                });

                transcricaoAtual = output.text;
                
                document.getElementById('resultado').innerHTML = 
                    `<h3>üìù Transcri√ß√£o:</h3><p>${transcricaoAtual}</p>`;
                document.getElementById('botoesExportacao').style.display = 'block';
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('resultado').innerHTML = 
                    `<p style="color: red;">Erro na transcri√ß√£o: ${error.message}</p>`;
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('btnTranscrever').disabled = false;
            }
        }

        function exportarCSV() {
            const csv = `Data,Hora,Transcri√ß√£o\n"${new Date().toLocaleDateString()}","${new Date().toLocaleTimeString()}","${transcricaoAtual.replace(/"/g, '""')}"`;
            downloadArquivo(csv, 'transcricao.csv', 'text/csv');
        }

        function salvarNoSheets() {
            // Implementar integra√ß√£o com Google Sheets
            alert('Funcionalidade Google Sheets seria implementada aqui!');
        }

        function copiarTexto() {
            navigator.clipboard.writeText(transcricaoAtual)
                .then(() => alert('Texto copiado!'))
                .catch(err => alert('Erro ao copiar: ' + err));
        }

        function downloadArquivo(conteudo, nome, tipo) {
            const blob = new Blob([conteudo], { type: tipo });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nome;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
